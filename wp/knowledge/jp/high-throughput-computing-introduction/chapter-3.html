<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Á¨¨3Á´†Ôºö„Ç∏„Éß„Éñ„Çπ„Ç±„Ç∏„É•„Éº„É™„É≥„Ç∞„Å®‰∏¶ÂàóÂåñÔºàSLURM, PBSÔºâ - AI Terakoya</title>

    <style>
        :root {
            --color-primary: #2c3e50;
            --color-primary-dark: #1a252f;
            --color-accent: #7b2cbf;
            --color-accent-light: #9d4edd;
            --color-text: #2d3748;
            --color-text-light: #4a5568;
            --color-bg: #ffffff;
            --color-bg-alt: #f7fafc;
            --color-border: #e2e8f0;
            --color-code-bg: #f8f9fa;
            --color-link: #3182ce;
            --color-link-hover: #2c5aa0;

            --spacing-xs: 0.5rem;
            --spacing-sm: 1rem;
            --spacing-md: 1.5rem;
            --spacing-lg: 2rem;
            --spacing-xl: 3rem;

            --font-body: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            --font-mono: "SFMono-Regular", Consolas, "Liberation Mono", Menlo, monospace;

            --border-radius: 8px;
            --box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: var(--font-body);
            line-height: 1.7;
            color: var(--color-text);
            background-color: var(--color-bg);
            font-size: 16px;
        }

        header {
            background: linear-gradient(135deg, var(--color-accent) 0%, var(--color-accent-light) 100%);
            color: white;
            padding: var(--spacing-xl) var(--spacing-md);
            margin-bottom: var(--spacing-xl);
            box-shadow: var(--box-shadow);
        }

        .header-content {
            max-width: 900px;
            margin: 0 auto;
        }

        h1 {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: var(--spacing-sm);
            line-height: 1.2;
        }

        .subtitle {
            font-size: 1.1rem;
            opacity: 0.95;
            font-weight: 400;
            margin-bottom: var(--spacing-md);
        }

        .meta {
            display: flex;
            flex-wrap: wrap;
            gap: var(--spacing-md);
            font-size: 0.9rem;
            opacity: 0.9;
        }

        .meta-item {
            display: flex;
            align-items: center;
            gap: 0.3rem;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            padding: 0 var(--spacing-md) var(--spacing-xl);
        }

        h2 {
            font-size: 1.75rem;
            color: var(--color-primary);
            margin-top: var(--spacing-xl);
            margin-bottom: var(--spacing-md);
            padding-bottom: var(--spacing-xs);
            border-bottom: 3px solid var(--color-accent);
        }

        h3 {
            font-size: 1.4rem;
            color: var(--color-primary);
            margin-top: var(--spacing-lg);
            margin-bottom: var(--spacing-sm);
        }

        h4 {
            font-size: 1.1rem;
            color: var(--color-primary-dark);
            margin-top: var(--spacing-md);
            margin-bottom: var(--spacing-sm);
        }

        p {
            margin-bottom: var(--spacing-md);
            color: var(--color-text);
        }

        a {
            color: var(--color-link);
            text-decoration: none;
            transition: color 0.2s;
        }

        a:hover {
            color: var(--color-link-hover);
            text-decoration: underline;
        }

        ul, ol {
            margin-left: var(--spacing-lg);
            margin-bottom: var(--spacing-md);
        }

        li {
            margin-bottom: var(--spacing-xs);
            color: var(--color-text);
        }

        pre {
            background-color: var(--color-code-bg);
            border: 1px solid var(--color-border);
            border-radius: var(--border-radius);
            padding: var(--spacing-md);
            overflow-x: auto;
            margin-bottom: var(--spacing-md);
            font-family: var(--font-mono);
            font-size: 0.9rem;
            line-height: 1.5;
        }

        code {
            font-family: var(--font-mono);
            font-size: 0.9em;
            background-color: var(--color-code-bg);
            padding: 0.2em 0.4em;
            border-radius: 3px;
        }

        pre code {
            background-color: transparent;
            padding: 0;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: var(--spacing-md);
            font-size: 0.95rem;
        }

        th, td {
            border: 1px solid var(--color-border);
            padding: var(--spacing-sm);
            text-align: left;
        }

        th {
            background-color: var(--color-bg-alt);
            font-weight: 600;
            color: var(--color-primary);
        }

        blockquote {
            border-left: 4px solid var(--color-accent);
            padding-left: var(--spacing-md);
            margin: var(--spacing-md) 0;
            color: var(--color-text-light);
            font-style: italic;
            background-color: var(--color-bg-alt);
            padding: var(--spacing-md);
            border-radius: var(--border-radius);
        }

        .mermaid {
            text-align: center;
            margin: var(--spacing-lg) 0;
            background-color: var(--color-bg-alt);
            padding: var(--spacing-md);
            border-radius: var(--border-radius);
        }

        details {
            background-color: var(--color-bg-alt);
            border: 1px solid var(--color-border);
            border-radius: var(--border-radius);
            padding: var(--spacing-md);
            margin-bottom: var(--spacing-md);
        }

        summary {
            cursor: pointer;
            font-weight: 600;
            color: var(--color-primary);
            user-select: none;
            padding: var(--spacing-xs);
            margin: calc(-1 * var(--spacing-md));
            padding: var(--spacing-md);
            border-radius: var(--border-radius);
        }

        summary:hover {
            background-color: rgba(123, 44, 191, 0.1);
        }

        details[open] summary {
            margin-bottom: var(--spacing-md);
            border-bottom: 1px solid var(--color-border);
        }

        .learning-objectives {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            padding: var(--spacing-lg);
            border-radius: var(--border-radius);
            border-left: 4px solid var(--color-accent);
            margin-bottom: var(--spacing-xl);
        }

        .learning-objectives h2 {
            margin-top: 0;
            border-bottom: none;
        }

        .navigation {
            display: flex;
            justify-content: space-between;
            gap: var(--spacing-md);
            margin: var(--spacing-xl) 0;
            padding-top: var(--spacing-lg);
            border-top: 2px solid var(--color-border);
        }

        .nav-button {
            flex: 1;
            padding: var(--spacing-md);
            background: linear-gradient(135deg, var(--color-accent) 0%, var(--color-accent-light) 100%);
            color: white;
            border-radius: var(--border-radius);
            text-align: center;
            font-weight: 600;
            transition: transform 0.2s, box-shadow 0.2s;
            box-shadow: var(--box-shadow);
        }

        .nav-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            text-decoration: none;
        }

        footer {
            margin-top: var(--spacing-xl);
            padding: var(--spacing-lg) var(--spacing-md);
            background-color: var(--color-bg-alt);
            border-top: 1px solid var(--color-border);
            text-align: center;
            font-size: 0.9rem;
            color: var(--color-text-light);
        }

        @media (max-width: 768px) {
            h1 {
                font-size: 1.5rem;
            }

            h2 {
                font-size: 1.4rem;
            }

            h3 {
                font-size: 1.2rem;
            }

            .meta {
                font-size: 0.85rem;
            }

            .navigation {
                flex-direction: column;
            }

            table {
                font-size: 0.85rem;
            }

            th, td {
                padding: var(--spacing-xs);
            }
        }
    </style>

    <script type="module">
        import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.esm.min.mjs';
        mermaid.initialize({ startOnLoad: true, theme: 'default' });
    </script>

    <!-- MathJax for LaTeX equation rendering -->
    <script>
        MathJax = {
            tex: {
                inlineMath: [['$', '$'], ['\(', '\)']],
                displayMath: [['$$', '$$'], ['\[', '\]']],
                processEscapes: true,
                processEnvironments: true
            },
            options: {
                skipHtmlTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
            }
        };
    </script>
    <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js" id="MathJax-script" async></script>
</head>
<body>
    <header>
        <div class="header-content">
            <h1>Á¨¨3Á´†Ôºö„Ç∏„Éß„Éñ„Çπ„Ç±„Ç∏„É•„Éº„É™„É≥„Ç∞„Å®‰∏¶ÂàóÂåñÔºàSLURM, PBSÔºâ</h1>
            <p class="subtitle"></p>
            <div class="meta">
                <span class="meta-item">üìñ Ë™≠‰∫ÜÊôÇÈñì: 25-30ÂàÜ</span>
                <span class="meta-item">üìä Èõ£ÊòìÂ∫¶: ‰∏äÁ¥ö</span>
                <span class="meta-item">üíª „Ç≥„Éº„Éâ‰æã: 5-6ÂÄã</span>
                <span class="meta-item">üìù ÊºîÁøíÂïèÈ°å: 0Âïè</span>
            </div>
        </div>
    </header>

    <main class="container">

<h1>Á¨¨3Á´†Ôºö„Ç∏„Éß„Éñ„Çπ„Ç±„Ç∏„É•„Éº„É™„É≥„Ç∞„Å®‰∏¶ÂàóÂåñÔºàSLURM, PBSÔºâ</h1>

<h2>Â≠¶ÁøíÁõÆÊ®ô</h2>

„Åì„ÅÆÁ´†„ÇíË™≠„ÇÄ„Åì„Å®„Åß„ÄÅ‰ª•‰∏ã„ÇíÁøíÂæó„Åß„Åç„Åæ„ÅôÔºö

- ‚úÖ SLURM„Çπ„ÇØ„É™„Éó„Éà„Çí‰ΩúÊàê„Åó„Å¶„Ç∏„Éß„Éñ„ÇíÊäïÂÖ•„Åß„Åç„Çã
- ‚úÖ MPI‰∏¶ÂàóË®àÁÆó„ÅÆÂäπÁéá„ÇíË©ï‰æ°„Åß„Åç„Çã
- ‚úÖ Python„Åß„Ç∏„Éß„ÉñÁÆ°ÁêÜ„Çπ„ÇØ„É™„Éó„Éà„ÇíÊõ∏„Åë„Çã
- ‚úÖ 1000ÊùêÊñôË¶èÊ®°„ÅÆ‰∏¶ÂàóË®àÁÆó„ÇíË®≠Ë®à„Åß„Åç„Çã
- ‚úÖ „Éô„É≥„ÉÅ„Éû„Éº„ÇØ„Å´„Çà„Çã„ÉÅ„É•„Éº„Éã„É≥„Ç∞„Åå„Åß„Åç„Çã

---

<h2>3.1 „Ç∏„Éß„Éñ„Çπ„Ç±„Ç∏„É•„Éº„É©„ÅÆÂü∫Á§é</h2>

<h3>SLURM vs PBS vs Torque</h3>

| ÁâπÂæ¥ | SLURM | PBS Pro | Torque |
|-----|-------|---------|--------|
| ÈñãÁô∫ÂÖÉ | SchedMD | Altair | Adaptive Computing |
| „É©„Ç§„Çª„É≥„Çπ | GPLÔºà‰∏ÄÈÉ®ÂïÜÁî®Ôºâ | ÂïÜÁî® | „Ç™„Éº„Éó„É≥„ÇΩ„Éº„Çπ |
| Êé°Áî®‰æã | TSUBAME„ÄÅTOP500„ÅÆÂ§ö„Åè | NASA„ÄÅDOEÂõΩÁ´ãÁ†îÁ©∂ÊâÄ | Â§ö„Åè„ÅÆÂ§ßÂ≠¶ |
| „Ç≥„Éû„É≥„Éâ | <code>sbatch</code>, <code>squeue</code> | <code>qsub</code>, <code>qstat</code> | <code>qsub</code>, <code>qstat</code> |
| Êé®Â•®Áî®ÈÄî | Â§ßË¶èÊ®°HPC | „Ç®„É≥„Çø„Éº„Éó„É©„Ç§„Ç∫ | ‰∏≠Â∞èË¶èÊ®°HPC |

<h3>SLURM„ÅÆÂü∫Êú¨Ê¶ÇÂøµ</h3>

<div class="mermaid">graph TD
    A[„É¶„Éº„Ç∂„Éº] -->|sbatch| B[„Ç∏„Éß„Éñ„Ç≠„É•„Éº]
    B --> C{„Çπ„Ç±„Ç∏„É•„Éº„É©}
    C -->|„É™„ÇΩ„Éº„ÇπÂâ≤ÂΩì| D[Ë®àÁÆó„Éé„Éº„Éâ1]
    C -->|„É™„ÇΩ„Éº„ÇπÂâ≤ÂΩì| E[Ë®àÁÆó„Éé„Éº„Éâ2]
    C -->|„É™„ÇΩ„Éº„ÇπÂâ≤ÂΩì| F[Ë®àÁÆó„Éé„Éº„ÉâN]

    D --> G[„Ç∏„Éß„ÉñÂÆå‰∫Ü]
    E --> G
    F --> G

    style C fill:#4ecdc4</div>

<strong>‰∏ªË¶Å„Ç≥„Éû„É≥„Éâ</strong>:

<pre><code class="language-bash"><h1>„Ç∏„Éß„ÉñÊäïÂÖ•</h1>
sbatch job.sh

<h1>„Ç∏„Éß„ÉñÁä∂ÊÖãÁ¢∫Ë™ç</h1>
squeue -u username

<h1>„Ç∏„Éß„Éñ„Ç≠„É£„É≥„Çª„É´</h1>
scancel job_id

<h1>„Éé„Éº„ÉâÊÉÖÂ†±</h1>
sinfo

<h1>„Ç∏„Éß„ÉñË©≥Á¥∞</h1>
scontrol show job job_id</code></pre>

---

<h2>3.2 SLURM„Çπ„ÇØ„É™„Éó„Éà‰ΩúÊàê</h2>

<h3>Âü∫Êú¨ÁöÑ„Å™SLURM„Çπ„ÇØ„É™„Éó„Éà</h3>

<pre><code class="language-bash">#!/bin/bash
#SBATCH --job-name=vasp_relax       # „Ç∏„Éß„ÉñÂêç
#SBATCH --output=slurm-%j.out       # Ê®ôÊ∫ñÂá∫ÂäõÔºà%j=„Ç∏„Éß„ÉñIDÔºâ
#SBATCH --error=slurm-%j.err        # Ê®ôÊ∫ñ„Ç®„É©„Éº
#SBATCH --nodes=1                   # „Éé„Éº„ÉâÊï∞
#SBATCH --ntasks-per-node=48        # „Éé„Éº„Éâ„ÅÇ„Åü„ÇäMPI„Éó„É≠„Çª„ÇπÊï∞
#SBATCH --cpus-per-task=1           # „Çø„Çπ„ÇØ„ÅÇ„Åü„Çä„Çπ„É¨„ÉÉ„ÉâÊï∞
#SBATCH --time=24:00:00             # ÊôÇÈñìÂà∂ÈôêÔºà24ÊôÇÈñìÔºâ
#SBATCH --partition=standard        # „Éë„Éº„ÉÜ„Ç£„Ç∑„Éß„É≥Ôºà„Ç≠„É•„ÉºÔºâ
#SBATCH --account=project_name      # „Éó„É≠„Ç∏„Çß„ÇØ„ÉàÂêç

<h1>Áí∞Â¢ÉË®≠ÂÆö</h1>
module purge
module load intel/2021.2
module load vasp/6.3.0

<h1>‰ΩúÊ•≠„Éá„Ç£„É¨„ÇØ„Éà„É™</h1>
cd $SLURM_SUBMIT_DIR

<h1>VASPÂÆüË°å</h1>
echo "„Ç∏„Éß„ÉñÈñãÂßã: $(date)"
echo "„Éõ„Çπ„Éà: $(hostname)"
echo "„Éé„Éº„ÉâÊï∞: $SLURM_JOB_NUM_NODES"
echo "„Éó„É≠„Çª„ÇπÊï∞: $SLURM_NTASKS"

mpirun -np $SLURM_NTASKS vasp_std

echo "„Ç∏„Éß„ÉñÁµÇ‰∫Ü: $(date)"</code></pre>

<h3>„Ç¢„É¨„Ç§„Ç∏„Éß„Éñ„Å´„Çà„Çã‰∏¶ÂàóÂÆüË°å</h3>

<strong>100ÊùêÊñô„Çí‰∏¶ÂàóË®àÁÆó</strong>:

<pre><code class="language-bash">#!/bin/bash
#SBATCH --job-name=vasp_array
#SBATCH --output=logs/slurm-%A_%a.out  # %A=„Ç¢„É¨„Ç§„Ç∏„Éß„ÉñID, %a=„Çø„Çπ„ÇØID
#SBATCH --error=logs/slurm-%A_%a.err
#SBATCH --nodes=1
#SBATCH --ntasks-per-node=48
#SBATCH --time=24:00:00
#SBATCH --array=1-100%10              # 1-100„ÅÆ„Çø„Çπ„ÇØ„ÄÅÂêåÊôÇ10ÂÄã„Åæ„Åß

<h1>Áí∞Â¢ÉË®≠ÂÆö</h1>
module load vasp/6.3.0

<h1>ÊùêÊñô„É™„Çπ„ÉàË™≠„ÅøËæº„Åø</h1>
MATERIAL_LIST="materials.txt"
MATERIAL=$(sed -n "${SLURM_ARRAY_TASK_ID}p" $MATERIAL_LIST)

echo "Âá¶ÁêÜ‰∏≠: „Çø„Çπ„ÇØID=${SLURM_ARRAY_TASK_ID}, ÊùêÊñô=${MATERIAL}"

<h1>‰ΩúÊ•≠„Éá„Ç£„É¨„ÇØ„Éà„É™</h1>
WORK_DIR="calculations/${MATERIAL}"
cd $WORK_DIR

<h1>VASPÂÆüË°å</h1>
mpirun -np 48 vasp_std

<h1>ÂèéÊùü„ÉÅ„Çß„ÉÉ„ÇØ</h1>
if grep -q "reached required accuracy" OUTCAR; then
    echo "SUCCESS: ${MATERIAL}" >> ../completed.log
else
    echo "FAILED: ${MATERIAL}" >> ../failed.log
fi</code></pre>

<strong>materials.txt</strong>„ÅÆ‰æã:
<pre><code>LiCoO2
LiNiO2
LiMnO2
LiFePO4
...Ôºà100Ë°åÔºâ</code></pre>

<h3>‰æùÂ≠òÈñ¢‰øÇ„ÅÆ„ÅÇ„Çã„Ç∏„Éß„Éñ„ÉÅ„Çß„Éº„É≥</h3>

<pre><code class="language-bash"><h1>Step 1: ÊßãÈÄ†ÊúÄÈÅ©Âåñ</h1>
JOB1=$(sbatch --parsable relax.sh)
echo "ÊßãÈÄ†ÊúÄÈÅ©Âåñ„Ç∏„Éß„ÉñID: $JOB1"

<h1>Step 2: ÈùôÁöÑË®àÁÆóÔºàÊßãÈÄ†ÊúÄÈÅ©ÂåñÂæå„Å´ÂÆüË°åÔºâ</h1>
JOB2=$(sbatch --parsable --dependency=afterok:$JOB1 static.sh)
echo "ÈùôÁöÑË®àÁÆó„Ç∏„Éß„ÉñID: $JOB2"

<h1>Step 3: „Éê„É≥„ÉâÊßãÈÄ†ÔºàÈùôÁöÑË®àÁÆóÂæå„Å´ÂÆüË°åÔºâ</h1>
JOB3=$(sbatch --parsable --dependency=afterok:$JOB2 band.sh)
echo "„Éê„É≥„ÉâÊßãÈÄ†„Ç∏„Éß„ÉñID: $JOB3"

<h1>Step 4: „Éá„Éº„ÇøËß£ÊûêÔºàÂÖ®„Å¶ÂÆå‰∫ÜÂæåÔºâ</h1>
sbatch --dependency=afterok:$JOB3 analysis.sh</code></pre>

---

<h2>3.3 MPI„Å´„Çà„Çã‰∏¶ÂàóË®àÁÆó</h2>

<h3>‰∏¶ÂàóÂåñ„ÅÆÁ®ÆÈ°û</h3>

<pre><code class="language-python"><h1>1. „Çø„Çπ„ÇØ‰∏¶ÂàóÔºàÊé®Â•®Ôºö„Éè„Ç§„Çπ„É´„Éº„Éó„ÉÉ„ÉàË®àÁÆóÔºâ</h1>
<h1>100ÊùêÊñô„Çí100„Éé„Éº„Éâ„ÅßÂêåÊôÇË®àÁÆó</h1>
<h1>„Çπ„Ç±„Éº„É™„É≥„Ç∞ÂäπÁéá: 100%</h1>

<h1>2. „Éá„Éº„Çø‰∏¶ÂàóÔºàVASP: KPARË®≠ÂÆöÔºâ</h1>
<h1>k-point„Çí4„Ç∞„É´„Éº„Éó„Å´ÂàÜÂâ≤</h1>
INCAR: KPAR = 4
<h1>„Çπ„Ç±„Éº„É™„É≥„Ç∞ÂäπÁéá: 80-90%</h1>

<h1>3. MPI‰∏¶ÂàóÔºà„Éó„É≠„Çª„ÇπÈñìÈÄö‰ø°Ôºâ</h1>
<h1>1Ë®àÁÆó„Çí48„Ç≥„Ç¢„ÅßÂàÜÊï£</h1>
mpirun -np 48 vasp_std
<h1>„Çπ„Ç±„Éº„É™„É≥„Ç∞ÂäπÁéá: 50-70%</h1></code></pre>

<h3>„Çπ„Ç±„Éº„É™„É≥„Ç∞ÂäπÁéá„ÅÆÊ∏¨ÂÆö</h3>

<pre><code class="language-python">import subprocess
import time
import numpy as np
import matplotlib.pyplot as plt

def benchmark_scaling(structure, core_counts=[1, 2, 4, 8, 16, 32, 48]):
    """
    ‰∏¶ÂàóÂåñÂäπÁéá„Çí„Éô„É≥„ÉÅ„Éû„Éº„ÇØ

    Parameters:
    -----------
    structure : str
        „ÉÜ„Çπ„ÉàÊßãÈÄ†
    core_counts : list
        „ÉÜ„Çπ„Éà„Åô„Çã„Ç≥„Ç¢Êï∞

    Returns:
    --------
    efficiency : dict
        „Ç≥„Ç¢Êï∞„Åî„Å®„ÅÆÂäπÁéá
    """
    timings = {}

    for n_cores in core_counts:
        # VASPÂÆüË°å
        start = time.time()

        result = subprocess.run(
            [f"mpirun -np {n_cores} vasp_std"],
            shell=True,
            cwd=f"benchmark_{n_cores}cores"
        )

        elapsed = time.time() - start
        timings[n_cores] = elapsed

        print(f"{n_cores}„Ç≥„Ç¢: {elapsed:.1f}Áßí")

    # ÂäπÁéáË®àÁÆó
    base_time = timings[1]
    efficiency = {}

    for n_cores, t in timings.items():
        ideal_time = base_time / n_cores
        actual_speedup = base_time / t
        ideal_speedup = n_cores

        eff = (actual_speedup / ideal_speedup) * 100
        efficiency[n_cores] = eff

    return efficiency, timings

<h1>ÁµêÊûú„Éó„É≠„ÉÉ„Éà</h1>
def plot_scaling(efficiency, timings):
    fig, (ax1, ax2) = plt.subplots(1, 2, figsize=(12, 5))

    cores = list(timings.keys())
    times = list(timings.values())
    effs = [efficiency[c] for c in cores]

    # „Çπ„Éî„Éº„Éâ„Ç¢„ÉÉ„Éó
    ax1.plot(cores, [timings[1]/t for t in times], 'o-', label='ÂÆüÊ∏¨')
    ax1.plot(cores, cores, '--', label='ÁêÜÊÉ≥ÔºàÁ∑öÂΩ¢Ôºâ')
    ax1.set_xlabel('„Ç≥„Ç¢Êï∞')
    ax1.set_ylabel('„Çπ„Éî„Éº„Éâ„Ç¢„ÉÉ„Éó')
    ax1.set_xscale('log', base=2)
    ax1.set_yscale('log', base=2)
    ax1.legend()
    ax1.grid(True)

    # ÂäπÁéá
    ax2.plot(cores, effs, 'o-', color='green')
    ax2.axhline(y=80, color='red', linestyle='--', label='80%ÁõÆÊ®ô')
    ax2.set_xlabel('„Ç≥„Ç¢Êï∞')
    ax2.set_ylabel('‰∏¶ÂàóÂåñÂäπÁéá (%)')
    ax2.set_xscale('log', base=2)
    ax2.legend()
    ax2.grid(True)

    plt.tight_layout()
    plt.savefig('scaling_benchmark.png', dpi=300)
    plt.show()</code></pre>

<h3>VASP„ÅÆ‰∏¶ÂàóÂåñ„Éë„É©„É°„Éº„ÇøÊúÄÈÅ©Âåñ</h3>

<pre><code class="language-python">def optimize_vasp_parallelization(n_kpoints, n_bands, n_cores=48):
    """
    VASP‰∏¶ÂàóÂåñ„Éë„É©„É°„Éº„Çø„ÅÆÊúÄÈÅ©Âåñ

    Parameters:
    -----------
    n_kpoints : int
        k-pointÊï∞
    n_bands : int
        „Éê„É≥„ÉâÊï∞
    n_cores : int
        Âà©Áî®ÂèØËÉΩ„Å™„Ç≥„Ç¢Êï∞

    Returns:
    --------
    params : dict
        ÊúÄÈÅ©„Éë„É©„É°„Éº„Çø
    """
    # KPAR: k-point‰∏¶ÂàóÔºàÊúÄ„ÇÇÂäπÁéáÁöÑÔºâ
    # 2„ÅÆÁ¥Ø‰πó„Åß„ÄÅk-pointÊï∞„ÅÆÁ¥ÑÊï∞
    kpar_options = [1, 2, 4, 8, 16]
    valid_kpar = [k for k in kpar_options if n_kpoints % k == 0 and k <= n_cores]

    # NCORE: „Éê„É≥„Éâ‰∏¶Âàó
    # ÈÄöÂ∏∏4-8„ÅåÊúÄÈÅ©
    ncore = min(4, n_cores // max(valid_kpar))

    # Êé®Â•®Ë®≠ÂÆö
    recommended = {
        'KPAR': max(valid_kpar),
        'NCORE': ncore,
        'cores_per_kpar_group': n_cores // max(valid_kpar),
    }

    print("‰∏¶ÂàóÂåñ„Éë„É©„É°„Éº„ÇøÊé®Â•®ÂÄ§:")
    print(f"  KPAR = {recommended['KPAR']} (k-point‰∏¶Âàó)")
    print(f"  NCORE = {recommended['NCORE']} („Éê„É≥„Éâ‰∏¶Âàó)")
    print(f"  1 KPAR„Ç∞„É´„Éº„Éó„ÅÇ„Åü„Çä{recommended['cores_per_kpar_group']}„Ç≥„Ç¢")

    return recommended

<h1>‰ΩøÁî®‰æã</h1>
params = optimize_vasp_parallelization(n_kpoints=64, n_bands=200, n_cores=48)
<h1>Êé®Â•®:</h1>
<h1>  KPAR = 16 (k-point‰∏¶Âàó)</h1>
<h1>  NCORE = 3 („Éê„É≥„Éâ‰∏¶Âàó)</h1>
<h1>  1 KPAR„Ç∞„É´„Éº„Éó„ÅÇ„Åü„Çä3„Ç≥„Ç¢</h1></code></pre>

---

<h2>3.4 Python„Å´„Çà„Çã„Ç∏„Éß„ÉñÁÆ°ÁêÜ</h2>

<h3>„Ç∏„Éß„ÉñÊäïÂÖ•„Å®Áõ£Ë¶ñ</h3>

<pre><code class="language-python">import subprocess
import time
import re

class SLURMJobManager:
    """SLURM„Ç∏„Éß„ÉñÁÆ°ÁêÜ„ÇØ„É©„Çπ"""

    def submit_job(self, script_path):
        """
        „Ç∏„Éß„Éñ„ÇíÊäïÂÖ•

        Returns:
        --------
        job_id : int
            „Ç∏„Éß„ÉñID
        """
        result = subprocess.run(
            ['sbatch', script_path],
            capture_output=True,
            text=True
        )

        # "Submitted batch job 12345"„Åã„ÇâID„ÇíÊäΩÂá∫
        match = re.search(r'(\d+)', result.stdout)
        if match:
            job_id = int(match.group(1))
            print(f"„Ç∏„Éß„ÉñÊäïÂÖ•: ID={job_id}")
            return job_id
        else:
            raise RuntimeError(f"„Ç∏„Éß„ÉñÊäïÂÖ•Â§±Êïó: {result.stderr}")

    def get_job_status(self, job_id):
        """
        „Ç∏„Éß„ÉñÁä∂ÊÖã„ÇíÂèñÂæó

        Returns:
        --------
        status : str
            'PENDING', 'RUNNING', 'COMPLETED', 'FAILED', 'CANCELLED'
        """
        result = subprocess.run(
            ['squeue', '-j', str(job_id), '-h', '-o', '%T'],
            capture_output=True,
            text=True
        )

        if result.stdout.strip():
            return result.stdout.strip()
        else:
            # „Ç≠„É•„Éº„Å´„Å™„ÅÑ ‚Üí ÂÆå‰∫Ü„Åæ„Åü„ÅØÂ§±Êïó
            result = subprocess.run(
                ['sacct', '-j', str(job_id), '-X', '-n', '-o', 'State'],
                capture_output=True,
                text=True
            )
            return result.stdout.strip()

    def wait_for_completion(self, job_id, check_interval=60):
        """
        „Ç∏„Éß„ÉñÂÆå‰∫Ü„ÇíÂæÖÊ©ü

        Parameters:
        -----------
        job_id : int
            „Ç∏„Éß„ÉñID
        check_interval : int
            „ÉÅ„Çß„ÉÉ„ÇØÈñìÈöîÔºàÁßíÔºâ
        """
        while True:
            status = self.get_job_status(job_id)

            if status in ['COMPLETED', 'FAILED', 'CANCELLED']:
                print(f"„Ç∏„Éß„Éñ{job_id}: {status}")
                return status

            print(f"„Ç∏„Éß„Éñ{job_id}: {status}...ÂæÖÊ©ü‰∏≠")
            time.sleep(check_interval)

    def submit_array_job(self, script_path, n_tasks, max_concurrent=10):
        """
        „Ç¢„É¨„Ç§„Ç∏„Éß„Éñ„ÇíÊäïÂÖ•

        Parameters:
        -----------
        n_tasks : int
            „Çø„Çπ„ÇØÊï∞
        max_concurrent : int
            ÂêåÊôÇÂÆüË°åÊï∞
        """
        result = subprocess.run(
            ['sbatch', f'--array=1-{n_tasks}%{max_concurrent}', script_path],
            capture_output=True,
            text=True
        )

        match = re.search(r'(\d+)', result.stdout)
        if match:
            job_id = int(match.group(1))
            print(f"„Ç¢„É¨„Ç§„Ç∏„Éß„ÉñÊäïÂÖ•: ID={job_id}, „Çø„Çπ„ÇØÊï∞={n_tasks}")
            return job_id
        else:
            raise RuntimeError(f"ÊäïÂÖ•Â§±Êïó: {result.stderr}")

<h1>‰ΩøÁî®‰æã</h1>
manager = SLURMJobManager()

<h1>Âçò‰∏Ä„Ç∏„Éß„Éñ</h1>
job_id = manager.submit_job('relax.sh')
status = manager.wait_for_completion(job_id)

<h1>„Ç¢„É¨„Ç§„Ç∏„Éß„Éñ</h1>
array_id = manager.submit_array_job('array_job.sh', n_tasks=100, max_concurrent=20)</code></pre>

<h3>Â§ßË¶èÊ®°„Ç∏„Éß„ÉñÁÆ°ÁêÜÔºà1000ÊùêÊñôÔºâ</h3>

<pre><code class="language-python">import os
from pathlib import Path
import json

def manage_large_scale_calculation(materials, batch_size=100):
    """
    1000ÊùêÊñô„ÇíÂäπÁéáÁöÑ„Å´ÁÆ°ÁêÜ

    Parameters:
    -----------
    materials : list
        ÊùêÊñô„ÅÆ„É™„Çπ„Éà
    batch_size : int
        „Éê„ÉÉ„ÉÅ„Çµ„Ç§„Ç∫
    """
    manager = SLURMJobManager()
    n_materials = len(materials)

    print(f"Á∑èÊùêÊñôÊï∞: {n_materials}")
    print(f"„Éê„ÉÉ„ÉÅ„Çµ„Ç§„Ç∫: {batch_size}")

    # „Éê„ÉÉ„ÉÅ„Å´ÂàÜÂâ≤
    n_batches = (n_materials + batch_size - 1) // batch_size
    print(f"„Éê„ÉÉ„ÉÅÊï∞: {n_batches}")

    job_ids = []

    for batch_idx in range(n_batches):
        start_idx = batch_idx * batch_size
        end_idx = min((batch_idx + 1) * batch_size, n_materials)
        batch_materials = materials[start_idx:end_idx]

        print(f"\n„Éê„ÉÉ„ÉÅ {batch_idx+1}/{n_batches}")
        print(f"  ÊùêÊñôÊï∞: {len(batch_materials)}")

        # „Éê„ÉÉ„ÉÅÁî®ÊùêÊñô„É™„Çπ„Éà‰ΩúÊàê
        list_file = f"batch_{batch_idx+1}_materials.txt"
        with open(list_file, 'w') as f:
            for mat in batch_materials:
                f.write(f"{mat}\n")

        # „Ç¢„É¨„Ç§„Ç∏„Éß„ÉñÊäïÂÖ•
        job_id = manager.submit_array_job(
            'vasp_array.sh',
            n_tasks=len(batch_materials),
            max_concurrent=20
        )

        job_ids.append(job_id)

    # ÈÄ≤ÊçóÁõ£Ë¶ñ
    print("\nÈÄ≤ÊçóÁõ£Ë¶ñ‰∏≠...")
    completed = 0

    while completed < len(job_ids):
        time.sleep(300)  # 5ÂàÜ„Åî„Å®„Å´„ÉÅ„Çß„ÉÉ„ÇØ

        for i, job_id in enumerate(job_ids):
            status = manager.get_job_status(job_id)

            if status == 'COMPLETED' and i not in completed_jobs:
                completed += 1
                print(f"„Éê„ÉÉ„ÉÅ {i+1} ÂÆå‰∫Ü ({completed}/{len(job_ids)})")

    print("ÂÖ®„Éê„ÉÉ„ÉÅÂÆå‰∫ÜÔºÅ")

<h1>‰ΩøÁî®‰æã</h1>
materials = [f"material_{i:04d}" for i in range(1, 1001)]
manage_large_scale_calculation(materials, batch_size=100)</code></pre>

---

<h2>3.5 ÊºîÁøíÂïèÈ°å</h2>

<h3>ÂïèÈ°å1ÔºàÈõ£ÊòìÂ∫¶: easyÔºâ</h3>

<strong>ÂïèÈ°å</strong>: ‰ª•‰∏ã„ÅÆÊù°‰ª∂„ÅßSLURM„Çπ„ÇØ„É™„Éó„Éà„Çí‰ΩúÊàê„Åó„Å¶„Åè„Å†„Åï„ÅÑÔºö

- „Ç∏„Éß„ÉñÂêç: <code>si_bandgap</code>
- „Éé„Éº„ÉâÊï∞: 2
- „Éé„Éº„Éâ„ÅÇ„Åü„Çä„Éó„É≠„Çª„ÇπÊï∞: 24
- ÊôÇÈñìÂà∂Èôê: 12ÊôÇÈñì
- „Éë„Éº„ÉÜ„Ç£„Ç∑„Éß„É≥: <code>gpu</code>

<details>
<summary>Ëß£Á≠î‰æã</summary>

<pre><code class="language-bash">#!/bin/bash
#SBATCH --job-name=si_bandgap
#SBATCH --output=slurm-%j.out
#SBATCH --error=slurm-%j.err
#SBATCH --nodes=2
#SBATCH --ntasks-per-node=24
#SBATCH --time=12:00:00
#SBATCH --partition=gpu

module load vasp/6.3.0

cd $SLURM_SUBMIT_DIR

mpirun -np 48 vasp_std</code></pre>

</details>

<h3>ÂïèÈ°å2ÔºàÈõ£ÊòìÂ∫¶: mediumÔºâ</h3>

<strong>ÂïèÈ°å</strong>: 50ÂÄã„ÅÆÊßãÈÄ†ÊúÄÈÅ©ÂåñË®àÁÆó„Çí„ÄÅ10ÂÄã„Åö„Å§ÂêåÊôÇÂÆüË°å„Åô„Çã„Ç¢„É¨„Ç§„Ç∏„Éß„Éñ„Çí‰ΩúÊàê„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ

<details>
<summary>Ëß£Á≠î‰æã</summary>

<pre><code class="language-bash">#!/bin/bash
#SBATCH --job-name=relax_array
#SBATCH --output=logs/slurm-%A_%a.out
#SBATCH --error=logs/slurm-%A_%a.err
#SBATCH --nodes=1
#SBATCH --ntasks-per-node=48
#SBATCH --time=24:00:00
#SBATCH --array=1-50%10

module load vasp/6.3.0

MATERIAL=$(sed -n "${SLURM_ARRAY_TASK_ID}p" materials.txt)

cd calculations/${MATERIAL}

mpirun -np 48 vasp_std</code></pre>

</details>

<h3>ÂïèÈ°å3ÔºàÈõ£ÊòìÂ∫¶: hardÔºâ</h3>

<strong>ÂïèÈ°å</strong>: Python„Åß„ÄÅ1000ÊùêÊñô„ÅÆVASPË®àÁÆó„ÇíÁÆ°ÁêÜ„Åô„Çã„Çπ„ÇØ„É™„Éó„Éà„Çí‰ΩúÊàê„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇË¶Å‰ª∂Ôºö

1. 50ÊùêÊñô„Åö„Å§„Éê„ÉÉ„ÉÅÂá¶ÁêÜ
2. ÂêÑ„Éê„ÉÉ„ÉÅ„ÅØ20„Çø„Çπ„ÇØÂêåÊôÇÂÆüË°å
3. ÂÆå‰∫Ü„ÉªÂ§±Êïó„Çí„É≠„Ç∞Ë®òÈå≤
4. Â§±Êïó„Åó„Åü„Çø„Çπ„ÇØ„ÇíËá™Âãï„É™„Éà„É©„Ç§

<details>
<summary>Ëß£Á≠î‰æã</summary>

<pre><code class="language-python">import os
import time
import json
from pathlib import Path

class HighThroughputManager:
    def __init__(self, materials, batch_size=50, max_concurrent=20):
        self.materials = materials
        self.batch_size = batch_size
        self.max_concurrent = max_concurrent
        self.manager = SLURMJobManager()

        self.results = {
            'completed': [],
            'failed': [],
            'retry': []
        }

    def run_batch(self, batch_materials, batch_id):
        """„Éê„ÉÉ„ÉÅÂÆüË°å"""
        # ÊùêÊñô„É™„Çπ„Éà‰ΩúÊàê
        list_file = f"batch_{batch_id}.txt"
        with open(list_file, 'w') as f:
            for mat in batch_materials:
                f.write(f"{mat}\n")

        # „Ç∏„Éß„ÉñÊäïÂÖ•
        job_id = self.manager.submit_array_job(
            'vasp_array.sh',
            n_tasks=len(batch_materials),
            max_concurrent=self.max_concurrent
        )

        # ÂÆå‰∫ÜÂæÖ„Å°
        status = self.manager.wait_for_completion(job_id)

        # ÁµêÊûú„ÉÅ„Çß„ÉÉ„ÇØ
        self.check_results(batch_materials, batch_id)

    def check_results(self, batch_materials, batch_id):
        """ÁµêÊûúÁ¢∫Ë™ç"""
        for mat in batch_materials:
            outcar = f"calculations/{mat}/OUTCAR"

            if not os.path.exists(outcar):
                self.results['failed'].append(mat)
                continue

            with open(outcar, 'r') as f:
                content = f.read()
                if 'reached required accuracy' in content:
                    self.results['completed'].append(mat)
                else:
                    self.results['failed'].append(mat)

        # „É≠„Ç∞‰øùÂ≠ò
        with open(f'batch_{batch_id}_results.json', 'w') as f:
            json.dump(self.results, f, indent=2)

    def retry_failed(self, max_retries=2):
        """Â§±Êïó„Çø„Çπ„ÇØ„Çí„É™„Éà„É©„Ç§"""
        for retry_count in range(max_retries):
            if not self.results['failed']:
                break

            print(f"\n„É™„Éà„É©„Ç§ {retry_count+1}/{max_retries}")
            print(f"  Â§±Êïó„Çø„Çπ„ÇØÊï∞: {len(self.results['failed'])}")

            failed_materials = self.results['failed'].copy()
            self.results['failed'] = []

            self.run_batch(failed_materials, f'retry_{retry_count+1}')

    def execute_all(self):
        """ÂÖ®ÊùêÊñô„ÇíÂÆüË°å"""
        n_batches = (len(self.materials) + self.batch_size - 1) // self.batch_size

        for batch_idx in range(n_batches):
            start = batch_idx * self.batch_size
            end = min((batch_idx + 1) * self.batch_size, len(self.materials))
            batch_materials = self.materials[start:end]

            print(f"\n„Éê„ÉÉ„ÉÅ {batch_idx+1}/{n_batches}")
            self.run_batch(batch_materials, batch_idx+1)

        # „É™„Éà„É©„Ç§
        self.retry_failed(max_retries=2)

        # ÊúÄÁµÇ„É¨„Éù„Éº„Éà
        print("\nÊúÄÁµÇÁµêÊûú:")
        print(f"  ÊàêÂäü: {len(self.results['completed'])}")
        print(f"  Â§±Êïó: {len(self.results['failed'])}")

        return self.results

<h1>ÂÆüË°å</h1>
materials = [f"material_{i:04d}" for i in range(1, 1001)]
manager = HighThroughputManager(materials, batch_size=50, max_concurrent=20)
results = manager.execute_all()</code></pre>

</details>

---

<h2>3.6 „Åæ„Å®„ÇÅ</h2>

<strong>„Ç≠„Éº„Éù„Ç§„É≥„Éà</strong>:

1. <strong>SLURM</strong>: Â§ßË¶èÊ®°HPC„ÅßÂ∫É„Åè‰ΩøÁî®„Åï„Çå„Çã„Ç∏„Éß„Éñ„Çπ„Ç±„Ç∏„É•„Éº„É©
2. <strong>„Ç¢„É¨„Ç§„Ç∏„Éß„Éñ</strong>: Â§öÊï∞„ÅÆÊùêÊñô„ÇíÂäπÁéáÁöÑ„Å´‰∏¶ÂàóÂÆüË°å
3. <strong>MPI‰∏¶Âàó</strong>: „Çπ„Ç±„Éº„É™„É≥„Ç∞ÂäπÁéá„ÇíÊ∏¨ÂÆö„ÉªÊúÄÈÅ©Âåñ
4. <strong>PythonÁÆ°ÁêÜ</strong>: Â§ßË¶èÊ®°Ë®àÁÆó„ÅÆËá™ÂãïÂåñ„Å®Áõ£Ë¶ñ

<strong>Ê¨°„ÅÆ„Çπ„ÉÜ„ÉÉ„Éó</strong>:

Á¨¨4Á´†„Åß„ÅØ„ÄÅ<strong>FireWorks„Å®AiiDA„Å´„Çà„Çã„ÉØ„Éº„ÇØ„Éï„É≠„ÉºÁÆ°ÁêÜ</strong>„ÇíÂ≠¶„Å≥„Åæ„Åô„ÄÇ

<strong>[Á¨¨4Á´†: „Éá„Éº„ÇøÁÆ°ÁêÜ„Å®„Éù„Çπ„Éà„Éó„É≠„Çª„Çπ ‚Üí](./chapter-4.md)</strong>

---

<strong>„É©„Ç§„Çª„É≥„Çπ</strong>: CC BY 4.0
<strong>‰ΩúÊàêÊó•</strong>: 2025-10-17
<strong>‰ΩúÊàêËÄÖ</strong>: Dr. Yusuke Hashimoto, Tohoku University
<div class="navigation">
    <a href="chapter-2.html" class="nav-button">‚Üê Á¨¨2Á´†</a>
    <a href="index.html" class="nav-button">„Ç∑„É™„Éº„Ç∫ÁõÆÊ¨°„Å´Êàª„Çã</a>
    <a href="chapter-4.html" class="nav-button">Á¨¨4Á´† ‚Üí</a>
</div>
    </main>

    <footer>
        <p><strong>‰ΩúÊàêËÄÖ</strong>: AI Terakoya Content Team</p>
        <p><strong>Áõ£‰øÆ</strong>: Dr. Yusuke HashimotoÔºàÊù±ÂåóÂ§ßÂ≠¶Ôºâ</p>
        <p><strong>„Éê„Éº„Ç∏„Éß„É≥</strong>: 1.0 | <strong>‰ΩúÊàêÊó•</strong>: 2025-10-17</p>
        <p><strong>„É©„Ç§„Çª„É≥„Çπ</strong>: Creative Commons BY 4.0</p>
        <p>¬© 2025 AI Terakoya. All rights reserved.</p>
    </footer>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const mermaidCodeBlocks = document.querySelectorAll('pre.codehilite code.language-mermaid, pre code.language-mermaid');

            mermaidCodeBlocks.forEach(function(codeBlock) {
                const pre = codeBlock.parentElement;
                const mermaidCode = codeBlock.textContent;

                const mermaidDiv = document.createElement('div');
                mermaidDiv.className = 'mermaid';
                mermaidDiv.textContent = mermaidCode.trim();

                pre.parentNode.replaceChild(mermaidDiv, pre);
            });

            if (typeof mermaid !== 'undefined') {
                mermaid.initialize({
                    startOnLoad: true,
                    theme: 'default'
                });
                mermaid.init(undefined, document.querySelectorAll('.mermaid'));
            }
        });
    </script>
</body>
</html>
