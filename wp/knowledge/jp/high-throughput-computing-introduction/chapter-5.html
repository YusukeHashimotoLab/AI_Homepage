<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>第5章：クラウドHPC活用と最適化 - AI Terakoya</title>

    <style>
        :root {
            --color-primary: #2c3e50;
            --color-primary-dark: #1a252f;
            --color-accent: #7b2cbf;
            --color-accent-light: #9d4edd;
            --color-text: #2d3748;
            --color-text-light: #4a5568;
            --color-bg: #ffffff;
            --color-bg-alt: #f7fafc;
            --color-border: #e2e8f0;
            --color-code-bg: #f8f9fa;
            --color-link: #3182ce;
            --color-link-hover: #2c5aa0;

            --spacing-xs: 0.5rem;
            --spacing-sm: 1rem;
            --spacing-md: 1.5rem;
            --spacing-lg: 2rem;
            --spacing-xl: 3rem;

            --font-body: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            --font-mono: "SFMono-Regular", Consolas, "Liberation Mono", Menlo, monospace;

            --border-radius: 8px;
            --box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: var(--font-body);
            line-height: 1.7;
            color: var(--color-text);
            background-color: var(--color-bg);
            font-size: 16px;
        }

        header {
            background: linear-gradient(135deg, var(--color-accent) 0%, var(--color-accent-light) 100%);
            color: white;
            padding: var(--spacing-xl) var(--spacing-md);
            margin-bottom: var(--spacing-xl);
            box-shadow: var(--box-shadow);
        }

        .header-content {
            max-width: 900px;
            margin: 0 auto;
        }

        h1 {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: var(--spacing-sm);
            line-height: 1.2;
        }

        .subtitle {
            font-size: 1.1rem;
            opacity: 0.95;
            font-weight: 400;
            margin-bottom: var(--spacing-md);
        }

        .meta {
            display: flex;
            flex-wrap: wrap;
            gap: var(--spacing-md);
            font-size: 0.9rem;
            opacity: 0.9;
        }

        .meta-item {
            display: flex;
            align-items: center;
            gap: 0.3rem;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            padding: 0 var(--spacing-md) var(--spacing-xl);
        }

        h2 {
            font-size: 1.75rem;
            color: var(--color-primary);
            margin-top: var(--spacing-xl);
            margin-bottom: var(--spacing-md);
            padding-bottom: var(--spacing-xs);
            border-bottom: 3px solid var(--color-accent);
        }

        h3 {
            font-size: 1.4rem;
            color: var(--color-primary);
            margin-top: var(--spacing-lg);
            margin-bottom: var(--spacing-sm);
        }

        h4 {
            font-size: 1.1rem;
            color: var(--color-primary-dark);
            margin-top: var(--spacing-md);
            margin-bottom: var(--spacing-sm);
        }

        p {
            margin-bottom: var(--spacing-md);
            color: var(--color-text);
        }

        a {
            color: var(--color-link);
            text-decoration: none;
            transition: color 0.2s;
        }

        a:hover {
            color: var(--color-link-hover);
            text-decoration: underline;
        }

        ul, ol {
            margin-left: var(--spacing-lg);
            margin-bottom: var(--spacing-md);
        }

        li {
            margin-bottom: var(--spacing-xs);
            color: var(--color-text);
        }

        pre {
            background-color: var(--color-code-bg);
            border: 1px solid var(--color-border);
            border-radius: var(--border-radius);
            padding: var(--spacing-md);
            overflow-x: auto;
            margin-bottom: var(--spacing-md);
            font-family: var(--font-mono);
            font-size: 0.9rem;
            line-height: 1.5;
        }

        code {
            font-family: var(--font-mono);
            font-size: 0.9em;
            background-color: var(--color-code-bg);
            padding: 0.2em 0.4em;
            border-radius: 3px;
        }

        pre code {
            background-color: transparent;
            padding: 0;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: var(--spacing-md);
            font-size: 0.95rem;
        }

        th, td {
            border: 1px solid var(--color-border);
            padding: var(--spacing-sm);
            text-align: left;
        }

        th {
            background-color: var(--color-bg-alt);
            font-weight: 600;
            color: var(--color-primary);
        }

        blockquote {
            border-left: 4px solid var(--color-accent);
            padding-left: var(--spacing-md);
            margin: var(--spacing-md) 0;
            color: var(--color-text-light);
            font-style: italic;
            background-color: var(--color-bg-alt);
            padding: var(--spacing-md);
            border-radius: var(--border-radius);
        }

        .mermaid {
            text-align: center;
            margin: var(--spacing-lg) 0;
            background-color: var(--color-bg-alt);
            padding: var(--spacing-md);
            border-radius: var(--border-radius);
        }

        details {
            background-color: var(--color-bg-alt);
            border: 1px solid var(--color-border);
            border-radius: var(--border-radius);
            padding: var(--spacing-md);
            margin-bottom: var(--spacing-md);
        }

        summary {
            cursor: pointer;
            font-weight: 600;
            color: var(--color-primary);
            user-select: none;
            padding: var(--spacing-xs);
            margin: calc(-1 * var(--spacing-md));
            padding: var(--spacing-md);
            border-radius: var(--border-radius);
        }

        summary:hover {
            background-color: rgba(123, 44, 191, 0.1);
        }

        details[open] summary {
            margin-bottom: var(--spacing-md);
            border-bottom: 1px solid var(--color-border);
        }

        .learning-objectives {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            padding: var(--spacing-lg);
            border-radius: var(--border-radius);
            border-left: 4px solid var(--color-accent);
            margin-bottom: var(--spacing-xl);
        }

        .learning-objectives h2 {
            margin-top: 0;
            border-bottom: none;
        }

        .navigation {
            display: flex;
            justify-content: space-between;
            gap: var(--spacing-md);
            margin: var(--spacing-xl) 0;
            padding-top: var(--spacing-lg);
            border-top: 2px solid var(--color-border);
        }

        .nav-button {
            flex: 1;
            padding: var(--spacing-md);
            background: linear-gradient(135deg, var(--color-accent) 0%, var(--color-accent-light) 100%);
            color: white;
            border-radius: var(--border-radius);
            text-align: center;
            font-weight: 600;
            transition: transform 0.2s, box-shadow 0.2s;
            box-shadow: var(--box-shadow);
        }

        .nav-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            text-decoration: none;
        }

        footer {
            margin-top: var(--spacing-xl);
            padding: var(--spacing-lg) var(--spacing-md);
            background-color: var(--color-bg-alt);
            border-top: 1px solid var(--color-border);
            text-align: center;
            font-size: 0.9rem;
            color: var(--color-text-light);
        }

        @media (max-width: 768px) {
            h1 {
                font-size: 1.5rem;
            }

            h2 {
                font-size: 1.4rem;
            }

            h3 {
                font-size: 1.2rem;
            }

            .meta {
                font-size: 0.85rem;
            }

            .navigation {
                flex-direction: column;
            }

            table {
                font-size: 0.85rem;
            }

            th, td {
                padding: var(--spacing-xs);
            }
        }
    </style>

    <script type="module">
        import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.esm.min.mjs';
        mermaid.initialize({ startOnLoad: true, theme: 'default' });
    </script>
</head>
<body>
    <header>
        <div class="header-content">
            <h1>第5章：クラウドHPC活用と最適化</h1>
            
            <div class="meta">
                <span class="meta-item">📖 読了時間: 15-20分</span>
<span class="meta-item">📊 難易度: 中級〜上級</span>
            </div>
        </div>
    </header>

    <main class="container">
        <h1>第5章：クラウドHPC活用と最適化</h1>

<h2>学習目標</h2>

<p>この章を読むことで、以下を習得できます：</p>

<ul>
<li>✅ AWS Parallel Clusterを構築できる</li>
<li>✅ スポットインスタンスでコストを50%削減できる</li>
<li>✅ Dockerで計算環境を完全再現できる</li>
<li>✅ 10,000材料規模のプロジェクトを設計・実行できる</li>
<li>✅ セキュリティとコンプライアンスを理解している</li>
</ul>

<p>---</p>

<h2>5.1 クラウドHPCの選択肢</h2>

<h3>主要クラウドプロバイダー比較</h3>

<p>| サービス | プロバイダー | 特徴 | 初期費用 | 推奨用途 |</p>
<p>|---------|-----------|------|---------|---------|</p>
<p>| <strong>AWS Parallel Cluster</strong> | Amazon | 最大規模、豊富な実績 | $0 | 大規模HPC |</p>
<p>| <strong>Google Cloud HPC Toolkit</strong> | Google | AI/ML統合が強力 | $0 | 機械学習連携 |</p>
<p>| <strong>Azure CycleCloud</strong> | Microsoft | Windows統合 | $0 | エンタープライズ |</p>
<p>| <strong>TSUBAME</strong> | 東工大 | 国内トップ、学術利用 | 申請制 | 学術研究 |</p>
<p>| <strong>富岳</strong> | 理研 | 世界トップ500 | 申請制 | 超大規模計算 |</p>

<h3>コスト比較（10,000材料、1材料=12 CPU時間、48コア）</h3>

<p>| オプション | 計算時間 | コスト | メリット | デメリット |</p>
<p>|----------|---------|-------|---------|---------|</p>
<p>| オンプレHPC | 5,760,000 CPU時間 | $0（既存設備） | 無料（利用枠内） | 待ち時間、制限 |</p>
<p>| AWS オンデマンド | 同上 | $4,000-6,000 | 即時利用可能 | 高コスト |</p>
<p>| AWS スポット | 同上 | $800-1,500 | 70%コスト削減 | 中断リスク |</p>
<p>| Google Cloud Preemptible | 同上 | $900-1,600 | 安価 | 24時間制限 |</p>

<p>---</p>

<h2>5.2 AWS Parallel Clusterセットアップ</h2>

<h3>前提条件</h3>

<pre><code class="language-bash"><h1>AWS CLIインストール</h1>
<p>pip install awscli</p>

<h1>AWS設定</h1>
<p>aws configure</p>
<h1>AWS Access Key ID: [YOUR_KEY]</h1>
<h1>AWS Secret Access Key: [YOUR_SECRET]</h1>
<h1>Default region: us-east-1</h1>
<h1>Default output format: json</h1>

<h1>Parallel Cluster CLIインストール</h1>
<p>pip install aws-parallelcluster</p>
</code></pre>

<h3>クラスタ設定ファイル</h3>

<strong>config.yaml</strong>:

<pre><code class="language-yaml">Region: us-east-1
<p>Image:</p>
<p>Os: alinux2</p>

<p>HeadNode:</p>
<p>InstanceType: c5.2xlarge  # 8 vCPU, 16 GB RAM</p>
<p>Networking:</p>
<p>SubnetId: subnet-12345678</p>
<p>Ssh:</p>
<p>KeyName: my-key-pair</p>

<p>Scheduling:</p>
<p>Scheduler: slurm</p>
<p>SlurmQueues:</p>
<p>- Name: compute</p>
<p>ComputeResources:</p>
<p>- Name: c5-48xlarge</p>
<p>InstanceType: c5.24xlarge  # 96 vCPU</p>
<p>MinCount: 0</p>
<p>MaxCount: 100  # 最大100ノード</p>
<p>DisableSimultaneousMultithreading: true</p>
<p>Efa:</p>
<p>Enabled: true  # 高速ネットワーク</p>
<p>Networking:</p>
<p>SubnetIds:</p>
<p>- subnet-12345678</p>
<p>PlacementGroup:</p>
<p>Enabled: true  # 低レイテンシ配置</p>

<p>SharedStorage:</p>
<p>- MountDir: /shared</p>
<p>Name: ebs-shared</p>
<p>StorageType: Ebs</p>
<p>EbsSettings:</p>
<p>VolumeType: gp3</p>
<p>Size: 1000  # 1 TB</p>
<p>Encrypted: true</p>

<p>- MountDir: /fsx</p>
<p>Name: lustre-fs</p>
<p>StorageType: FsxLustre</p>
<p>FsxLustreSettings:</p>
<p>StorageCapacity: 1200  # 1.2 TB</p>
<p>DeploymentType: SCRATCH_2</p>
</code></pre>

<h3>クラスタ作成</h3>

<pre><code class="language-bash"><h1>クラスタ作成</h1>
<p>pcluster create-cluster \</p>
<p>--cluster-name vasp-cluster \</p>
<p>--cluster-configuration config.yaml</p>

<h1>作成状態確認</h1>
<p>pcluster describe-cluster --cluster-name vasp-cluster</p>

<h1>SSH接続</h1>
<p>pcluster ssh --cluster-name vasp-cluster -i ~/.ssh/my-key-pair.pem</p>
</code></pre>

<h3>VASP環境セットアップ</h3>

<pre><code class="language-bash"><h1>クラスタにSSH接続後</h1>

<h1>Intel OneAPI Toolkit（VASPコンパイルに必要）</h1>
<p>wget https://registrationcenter-download.intel.com/...</p>
<p>bash l_BaseKit_p_2023.0.0.25537_offline.sh</p>

<h1>VASPコンパイル（ライセンスが必要）</h1>
<p>cd /shared</p>
<p>tar -xzf vasp.6.3.0.tar.gz</p>
<p>cd vasp.6.3.0</p>

<h1>makefile.include編集（Intel compiler用）</h1>
<p>cp arch/makefile.include.intel makefile.include</p>

<h1>コンパイル</h1>
<p>make all</p>

<h1>実行ファイルを共有ディレクトリに配置</h1>
<p>cp bin/vasp_std /shared/bin/</p>
</code></pre>

<p>---</p>

<h2>5.3 コスト最適化</h2>

<h3>スポットインスタンスの活用</h3>

<strong>スポットインスタンス</strong>は、オンデマンドの60-90%割引で利用できる余剰計算リソースです。

<strong>config.yaml（スポット設定）</strong>:

<pre><code class="language-yaml">Scheduling:
<p>Scheduler: slurm</p>
<p>SlurmQueues:</p>
<p>- Name: spot-queue</p>
<p>CapacityType: SPOT  # スポットインスタンス</p>
<p>ComputeResources:</p>
<p>- Name: c5-spot</p>
<p>InstanceType: c5.24xlarge</p>
<p>MinCount: 0</p>
<p>MaxCount: 200</p>
<p>SpotPrice: 2.50  # 最大入札価格（$/時）</p>
<p>Networking:</p>
<p>SubnetIds:</p>
<p>- subnet-12345678</p>
</code></pre>

<strong>スポットインスタンスのベストプラクティス</strong>:

<ol>
<li><strong>チェックポイント</strong>: 計算を定期的に保存</li>
<li><strong>複数インスタンスタイプ</strong>: 代替タイプを指定</li>
<li><strong>リトライ設定</strong>: 中断時の自動リスタート</li>
</ol>

<h3>自動スケーリング</h3>

<pre><code class="language-yaml">Scheduling:
<p>SlurmSettings:</p>
<p>ScaledownIdletime: 5  # 5分アイドルで終了</p>
<p>SlurmQueues:</p>
<p>- Name: compute</p>
<p>ComputeResources:</p>
<p>- Name: c5-instances</p>
<p>MinCount: 0      # アイドル時は0ノード</p>
<p>MaxCount: 100    # 最大100ノード</p>
</code></pre>

<h3>コスト監視</h3>

<pre><code class="language-python">import boto3
<p>from datetime import datetime, timedelta</p>

<p>def get_cluster_cost(cluster_name, days=7):</p>
<p>"""</p>
<p>クラスタのコストを取得</p>

<p>Parameters:</p>
<p>-----------</p>
<p>cluster_name : str</p>
<p>クラスタ名</p>
<p>days : int</p>
<p>過去何日分</p>

<p>Returns:</p>
<p>--------</p>
<p>cost : float</p>
<p>総コスト（USD）</p>
<p>"""</p>
<p>ce_client = boto3.client('ce', region_name='us-east-1')</p>

<p># 期間設定</p>
<p>end_date = datetime.now().date()</p>
<p>start_date = end_date - timedelta(days=days)</p>

<p># Cost Explorer API</p>
<p>response = ce_client.get_cost_and_usage(</p>
<p>TimePeriod={</p>
<p>'Start': start_date.strftime('%Y-%m-%d'),</p>
<p>'End': end_date.strftime('%Y-%m-%d')</p>
<p>},</p>
<p>Granularity='DAILY',</p>
<p>Metrics=['UnblendedCost'],</p>
<p>Filter={</p>
<p>'Tags': {</p>
<p>'Key': 'parallelcluster:cluster-name',</p>
<p>'Values': [cluster_name]</p>
<p>}</p>
<p>}</p>
<p>)</p>

<p>total_cost = 0</p>
<p>for result in response['ResultsByTime']:</p>
<p>cost = float(result['Total']['UnblendedCost']['Amount'])</p>
<p>total_cost += cost</p>
<p>print(f"{result['TimePeriod']['Start']}: ${cost:.2f}")</p>

<p>print(f"\n総コスト（{days}日間）: ${total_cost:.2f}")</p>
<p>return total_cost</p>

<h1>使用例</h1>
<p>get_cluster_cost('vasp-cluster', days=7)</p>
</code></pre>

<p>---</p>

<h2>5.4 Docker/Singularityによるコンテナ化</h2>

<h3>Dockerfileの作成</h3>

<strong>Dockerfile</strong>:

<pre><code class="language-dockerfile">FROM ubuntu:20.04

<h1>基本パッケージ</h1>
<p>RUN apt-get update && apt-get install -y \</p>
<p>build-essential \</p>
<p>gfortran \</p>
<p>openmpi-bin \</p>
<p>libopenmpi-dev \</p>
<p>python3 \</p>
<p>python3-pip \</p>
<p>wget \</p>
<p>&& rm -rf /var/lib/apt/lists/*</p>

<h1>Python環境</h1>
<p>RUN pip3 install --upgrade pip && \</p>
<p>pip3 install numpy scipy matplotlib \</p>
<p>ase pymatgen fireworks</p>

<h1>Intel MKL（数値計算ライブラリ）</h1>
<p>RUN wget https://apt.repos.intel.com/intel-gpg-keys/GPG-PUB-KEY-INTEL-SW-PRODUCTS.PUB && \</p>
<p>apt-key add GPG-PUB-KEY-INTEL-SW-PRODUCTS.PUB && \</p>
<p>echo "deb https://apt.repos.intel.com/oneapi all main" > /etc/apt/sources.list.d/oneAPI.list && \</p>
<p>apt-get update && \</p>
<p>apt-get install -y intel-oneapi-mkl</p>

<h1>VASP（ライセンス保持者のみ）</h1>
<h1>COPY vasp.6.3.0.tar.gz /tmp/</h1>
<h1>RUN cd /tmp && tar -xzf vasp.6.3.0.tar.gz && \</h1>
<h1>    cd vasp.6.3.0 && make all && \</h1>
<h1>    cp bin/vasp_std /usr/local/bin/</h1>

<h1>作業ディレクトリ</h1>
<p>WORKDIR /calculations</p>

<h1>デフォルトコマンド</h1>
<p>CMD ["/bin/bash"]</p>
</code></pre>

<h3>Docker イメージのビルドとプッシュ</h3>

<pre><code class="language-bash"><h1>イメージビルド</h1>
<p>docker build -t my-vasp-env:latest .</p>

<h1>Docker Hubにプッシュ（共有用）</h1>
<p>docker tag my-vasp-env:latest username/my-vasp-env:latest</p>
<p>docker push username/my-vasp-env:latest</p>

<h1>Amazon ECRにプッシュ（AWS用）</h1>
<p>aws ecr get-login-password --region us-east-1 | docker login --username AWS --password-stdin 123456789012.dkr.ecr.us-east-1.amazonaws.com</p>

<p>docker tag my-vasp-env:latest 123456789012.dkr.ecr.us-east-1.amazonaws.com/my-vasp-env:latest</p>
<p>docker push 123456789012.dkr.ecr.us-east-1.amazonaws.com/my-vasp-env:latest</p>
</code></pre>

<h3>SingularityでHPC実行</h3>

<p>HPCシステムではDockerの代わりにSingularityを使用します。</p>

<pre><code class="language-bash"><h1>DockerイメージからSingularityイメージを作成</h1>
<p>singularity build vasp-env.sif docker://username/my-vasp-env:latest</p>

<h1>Singularityコンテナで実行</h1>
<p>singularity exec vasp-env.sif mpirun -np 48 vasp_std</p>
</code></pre>

<strong>SLURMスクリプト（Singularity使用）</strong>:

<pre><code class="language-bash">#!/bin/bash
<p>#SBATCH --job-name=vasp-singularity</p>
<p>#SBATCH --nodes=1</p>
<p>#SBATCH --ntasks-per-node=48</p>
<p>#SBATCH --time=24:00:00</p>

<h1>Singularityイメージ</h1>
<p>IMAGE=/shared/containers/vasp-env.sif</p>

<h1>コンテナ内でVASP実行</h1>
<p>singularity exec $IMAGE mpirun -np 48 vasp_std</p>
</code></pre>

<p>---</p>

<h2>5.5 セキュリティとコンプライアンス</h2>

<h3>アクセス制御（IAM）</h3>

<strong>最小権限の原則</strong>:

<pre><code class="language-json">{
<p>"Version": "2012-10-17",</p>
<p>"Statement": [</p>
<p>{</p>
<p>"Effect": "Allow",</p>
<p>"Action": [</p>
<p>"ec2:DescribeInstances",</p>
<p>"ec2:DescribeVolumes",</p>
<p>"ec2:RunInstances",</p>
<p>"ec2:TerminateInstances"</p>
<p>],</p>
<p>"Resource": "*",</p>
<p>"Condition": {</p>
<p>"StringEquals": {</p>
<p>"aws:RequestedRegion": "us-east-1"</p>
<p>}</p>
<p>}</p>
<p>},</p>
<p>{</p>
<p>"Effect": "Allow",</p>
<p>"Action": [</p>
<p>"s3:GetObject",</p>
<p>"s3:PutObject"</p>
<p>],</p>
<p>"Resource": "arn:aws:s3:::my-vasp-bucket/*"</p>
<p>}</p>
<p>]</p>
<p>}</p>
</code></pre>

<h3>データ暗号化</h3>

<pre><code class="language-yaml"><h1>config.yaml（暗号化設定）</h1>
<p>SharedStorage:</p>
<p>- MountDir: /shared</p>
<p>Name: ebs-encrypted</p>
<p>StorageType: Ebs</p>
<p>EbsSettings:</p>
<p>VolumeType: gp3</p>
<p>Size: 1000</p>
<p>Encrypted: true  # 暗号化有効</p>
<p>KmsKeyId: arn:aws:kms:us-east-1:123456789012:key/12345678-1234-1234-1234-123456789012</p>
</code></pre>

<h3>学術ライセンス遵守</h3>

<strong>VASP</strong>等の商用ソフトウェアをクラウドで使用する場合の注意点：

<ol>
<li><strong>ライセンス確認</strong>: クラウド使用が許可されているか</li>
<li><strong>ノードロック</strong>: 特定ノードでの実行制限</li>
<li><strong>同時実行数</strong>: ライセンス数の制限</li>
<li><strong>監査ログ</strong>: 使用履歴の記録</li>
</ol>

<p>---</p>

<h2>5.6 ケーススタディ: 10,000材料スクリーニング</h2>

<h3>要件定義</h3>

<strong>目標</strong>: 10,000個の酸化物材料のバンドギャップを6ヶ月以内に計算

<strong>制約</strong>:
<ul>
<li>予算: $5,000</li>
<li>1材料あたり計算時間: 12時間（48コア）</li>
<li>総CPU時間: 5,760,000 CPU時間</li>
</ul>

<h3>アーキテクチャ設計</h3>

<pre><code class="language-mermaid">graph TD
<p>A[材料リスト<br/>10,000個] --> B[バッチ分割<br/>100バッチ × 100材料]</p>
<p>B --> C[AWS Parallel Cluster<br/>スポットインスタンス]</p>
<p>C --> D[SLURM アレイジョブ<br/>同時20ノード]</p>
<p>D --> E[FireWorks<br/>ワークフロー管理]</p>
<p>E --> F[MongoDB<br/>結果保存]</p>
<p>F --> G[S3<br/>長期保存]</p>
<p>G --> H[分析・可視化]</p>
</code></pre>

<h3>実装</h3>

<strong>1. クラスタ設定</strong>

<pre><code class="language-yaml"><h1>config-10k-materials.yaml</h1>
<p>Scheduling:</p>
<p>Scheduler: slurm</p>
<p>SlurmQueues:</p>
<p>- Name: spot-compute</p>
<p>CapacityType: SPOT</p>
<p>ComputeResources:</p>
<p>- Name: c5-24xlarge-spot</p>
<p>InstanceType: c5.24xlarge  # 96 vCPU</p>
<p>MinCount: 0</p>
<p>MaxCount: 50  # 同時50ノード = 4,800コア</p>
<p>SpotPrice: 2.00</p>
</code></pre>

<strong>2. ジョブ投入スクリプト</strong>

<pre><code class="language-python">def run_10k_project():
<p>"""10,000材料プロジェクト実行"""</p>

<p># 材料リスト読み込み</p>
<p>with open('oxide_materials_10k.txt', 'r') as f:</p>
<p>materials = [line.strip() for line in f]</p>

<p>print(f"総材料数: {len(materials)}")</p>

<p># 100バッチに分割</p>
<p>batch_size = 100</p>
<p>n_batches = len(materials) // batch_size</p>

<p>manager = SLURMJobManager()</p>

<p>for batch_id in range(n_batches):</p>
<p>start = batch_id * batch_size</p>
<p>end = (batch_id + 1) * batch_size</p>
<p>batch_materials = materials[start:end]</p>

<p># バッチ用材料リスト</p>
<p>list_file = f'batch_{batch_id:03d}.txt'</p>
<p>with open(list_file, 'w') as f:</p>
<p>for mat in batch_materials:</p>
<p>f.write(f"{mat}\n")</p>

<p># アレイジョブ投入（100材料、同時20ノード）</p>
<p>job_id = manager.submit_array_job(</p>
<p>'vasp_bandgap.sh',</p>
<p>n_tasks=100,</p>
<p>max_concurrent=20</p>
<p>)</p>

<p>print(f"バッチ {batch_id+1}/{n_batches} 投入: ジョブID {job_id}")</p>

<p># レート制限（AWS API制限対策）</p>
<p>time.sleep(1)</p>

<p>run_10k_project()</p>
</code></pre>

<strong>3. コスト分析</strong>

<pre><code class="language-python">def estimate_project_cost():
<p>"""プロジェクトコスト見積もり"""</p>

<p># パラメータ</p>
<p>n_materials = 10000</p>
<p>cpu_hours_per_material = 12</p>
<p>cores_per_job = 48</p>

<p>total_cpu_hours = n_materials * cpu_hours_per_material</p>

<p># c5.24xlarge: 96 vCPU, $4.08/時（オンデマンド）</p>
<p>ondemand_cost = total_cpu_hours * (4.08 / 96)</p>
<p>print(f"オンデマンド: ${ondemand_cost:,.0f}")</p>

<p># スポット: 70%割引</p>
<p>spot_cost = ondemand_cost * 0.3</p>
<p>print(f"スポット: ${spot_cost:,.0f}")</p>

<p># ストレージ: EBS 1TB × 6ヶ月</p>
<p>storage_cost = 0.10 <em> 1000 </em> 6  # $0.10/GB/月</p>
<p>print(f"ストレージ: ${storage_cost:,.0f}")</p>

<p># データ転送: 500GB</p>
<p>transfer_cost = 500 * 0.09</p>
<p>print(f"データ転送: ${transfer_cost:,.0f}")</p>

<p>total_cost = spot_cost + storage_cost + transfer_cost</p>
<p>print(f"\n総コスト: ${total_cost:,.0f}")</p>

<p>return total_cost</p>

<p>estimate_project_cost()</p>
</code></pre>

<strong>出力</strong>:
<pre><code class="language-">オンデマンド: $5,100
<p>スポット: $1,530</p>
<p>ストレージ: $600</p>
<p>データ転送: $45</p>

<p>総コスト: $2,175</p>
</code></pre>

<p>---</p>

<h2>5.7 演習問題</h2>

<h3>問題1（難易度: medium）</h3>

<strong>問題</strong>: AWS Parallel Clusterのコスト削減策を3つ挙げ、それぞれの削減率を見積もってください。

<details>
<summary>解答例</summary>

<strong>1. スポットインスタンス使用</strong>
<ul>
<li>削減率: 70%</li>
<li>リスク: 中断の可能性</li>
</ul>

<strong>2. 自動スケールダウン（5分アイドル）</strong>
<ul>
<li>削減率: 20-30%（アイドル時間による）</li>
<li>リスク: なし</li>
</ul>

<strong>3. リザーブドインスタンス（1年契約）</strong>
<ul>
<li>削減率: 40%</li>
<li>リスク: 長期コミットメント</li>
</ul>

<strong>総合削減率</strong>: 最大85%（スポット + 自動スケール）

</details>

<h3>問題2（難易度: hard）</h3>

<strong>問題</strong>: 5,000材料のプロジェクトで、予算$1,000、期間3ヶ月の制約下で最適な実行計画を立ててください。

<details>
<summary>解答例</summary>

<strong>パラメータ</strong>:
<ul>
<li>材料数: 5,000</li>
<li>CPU時間: 5,000 × 12時間 = 60,000時間</li>
<li>予算: $1,000</li>
<li>期間: 3ヶ月 = 90日</li>
</ul>

<strong>制約から逆算</strong>:

<p>コスト制約:</p>
<pre><code class="language-">$1,000 = 計算コスト + ストレージコスト + 転送コスト
<p>$1,000 ≈ $800（計算） + $150（ストレージ） + $50（転送）</p>
</code></pre>

<p>c5.24xlarge スポット: $1.22/時</p>
<pre><code class="language-">使用可能時間 = $800 / $1.22 = 656時間
<p>同時ノード数 = 60,000 / 656 / 24 = 3.8 ≈ 4ノード</p>
</code></pre>

<strong>実行計画</strong>:
<ol>
<li>スポットインスタンス: c5.24xlarge × 4ノード</li>
<li>同時実行: 16材料（各48コア）</li>
<li>1日あたり: 16材料 × 2バッチ = 32材料</li>
<li>完了期間: 5,000 / 32 = 156日</li>
</ol>

<strong>問題</strong>: 期間が3ヶ月（90日）を超過

<strong>解決策</strong>:
<ul>
<li>同時ノード数を8に増加 → コスト$1,600（予算超過）</li>
<li>または、1材料あたりCPU時間を8時間に削減（精度とトレードオフ）</li>
</ul>

</details>

<p>---</p>

<h2>5.8 まとめ</h2>

<p>この章では、クラウドHPCの活用とコスト最適化を学びました。</p>

<strong>キーポイント</strong>:

<ol>
<li><strong>AWS Parallel Cluster</strong>: 大規模HPC環境を簡単に構築</li>
<li><strong>スポットインスタンス</strong>: 70%のコスト削減</li>
<li><strong>Docker/Singularity</strong>: 環境の完全再現</li>
<li><strong>コスト管理</strong>: 見積もりと監視</li>
<li><strong>セキュリティ</strong>: 暗号化とアクセス制御</li>
</ol>

<strong>シリーズ完了おめでとうございます！</strong>

<p>これで、ハイスループット計算の全5章を完了しました。第1章の基礎概念から第5章のクラウド実装まで、実践的なスキルを習得できたはずです。</p>

<strong>次のステップ</strong>:

<ol>
<li>小規模プロジェクト（100-1000材料）を実行</li>
<li>コストを測定・最適化</li>
<li>結果をNOMADに公開</li>
<li>論文執筆・学会発表</li>
</ol>

<strong><a href="./index.md">シリーズトップに戻る</a></strong>

<p>---</p>

<h2>参考文献</h2>

<ol>
<li>Amazon Web Services (2023). "AWS Parallel Cluster User Guide." https://docs.aws.amazon.com/parallelcluster/</li>
</ol>

<ol>
<li>Kurtzer, G. M., et al. (2017). "Singularity: Scientific containers for mobility of compute." <em>PLOS ONE</em>, 12(5), e0177459.</li>
</ol>

<ol>
<li>Merkel, D. (2014). "Docker: lightweight Linux containers for consistent development and deployment." <em>Linux Journal</em>, 2014(239), 2.</li>
</ol>

<ol>
<li>NOMAD Laboratory (2023). "NOMAD Repository - FAIR Data Sharing." https://nomad-lab.eu/</li>
</ol>

<ol>
<li>Jain, A., et al. (2015). "FireWorks: a dynamic workflow system designed for high-throughput applications." <em>Concurrency and Computation: Practice and Experience</em>, 27(17), 5037-5059.</li>
</ol>

<p>---</p>

<strong>ライセンス</strong>: CC BY 4.0
<strong>作成日</strong>: 2025-10-17
<strong>作成者</strong>: Dr. Yusuke Hashimoto, Tohoku University

<p>---</p>

<strong>ハイスループット計算入門シリーズを完了しました！</strong>

<p>材料探索の加速化を実現し、世界に貢献する研究を期待しています。</p>


        <div class="navigation">
            <a href="chapter-4.html" class="nav-button">← 前章: 第4章</a>
<a href="index.html" class="nav-button">シリーズ目次に戻る →</a>
        </div>
    </main>

    <footer>
        <p><strong>作成者</strong>: AI Terakoya Content Team</p>
        <p><strong>監修</strong>: Dr. Yusuke Hashimoto（東北大学）</p>
        <p><strong>バージョン</strong>: 1.0 | <strong>作成日</strong>: 2025-10-17</p>
        <p><strong>ライセンス</strong>: Creative Commons BY 4.0</p>
        <p>© 2025 AI Terakoya. All rights reserved.</p>
    </footer>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const mermaidCodeBlocks = document.querySelectorAll('pre.codehilite code.language-mermaid, pre code.language-mermaid');

            mermaidCodeBlocks.forEach(function(codeBlock) {
                const pre = codeBlock.parentElement;
                const mermaidCode = codeBlock.textContent;

                const mermaidDiv = document.createElement('div');
                mermaidDiv.className = 'mermaid';
                mermaidDiv.textContent = mermaidCode.trim();

                pre.parentNode.replaceChild(mermaidDiv, pre);
            });

            if (typeof mermaid !== 'undefined') {
                mermaid.initialize({
                    startOnLoad: true,
                    theme: 'default'
                });
                mermaid.init(undefined, document.querySelectorAll('.mermaid'));
            }
        });
    </script>
</body>
</html>
